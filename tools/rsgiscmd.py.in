#!/usr/bin/env python

############################################################################
# Copyright (c) 2012 Dan Clewley, Aberystwyth University
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.
#
#
# Purpose:  A python script to generate XML files for use within RSGISLib from
#           command line options
# Author: Dan Clewley
# Email: daniel.clewley@gmail.com
# Date: 15/02/2012
# Version: 1.0
#
# History:
# Version 1.0 - Created.
#
#############################################################################

import sys, re, os
import tempfile as tempfile

incommand = ''
rsgiscmd = ''

first = True

if len(sys.argv) == 1 or (len(sys.argv) >= 2 and sys.argv[1] == '--help'):
    print '''rsgiscmd - Generates and runs an XML file within RSGISLib, using command line options.
Usage:
    rsgiscmd --xml '<rsgis:command XMLOPTIONS />'
or
    rsgiscmd --xmlvariable xmlparameter
eg:
    rsgiscmd --algor imagecalc --option apply2VarFunction --input INPUT_IMAGE.env 
        --output OUTPUT_IMAGE.env --function 2DPoly --coefficients COEFFICIENTS

This script was distributed with @RSGISLIB_PACKAGE_STRING@.
Copyright (C) @RSGISLIB_COPYRIGHT_YEAR@ Peter Bunting and Daniel Clewley

Report bugs on the trac or directly to @RSGISLIB_PACKAGE_BUGREPORT@

'''
    exit()

# Check for XML
if len(sys.argv) == 3 and sys.argv[1] == '--xml':
    rsgiscmd = sys.argv[2]

else:
    for par in sys.argv:
        if first: # don't include first option
            first = False
        else:
            incommand = incommand + ';' + str(par) # Seperate commands with a semi-colon
            
    optionParList = incommand.split('--', incommand.count('--'))
    rsgiscmd = '<rsgis:command '
    for optionPar in optionParList:
        command = optionPar.split(';',optionPar.count(';'))
        if command[0] != '':
            rsgiscmd = rsgiscmd + command[0] + '="' + command[1] + '" '
    rsgiscmd = rsgiscmd + ' />'

(osHandle, outXMLName) = tempfile.mkstemp(suffix='.xml')
outFile = open(outXMLName, 'w')
outLine = '''<rsgis:commands xmlns:rsgis=\"http://www.rsgislib.org/xml/\">
    %s
</rsgis:commands>
'''%rsgiscmd

outFile.write(outLine)
outFile.close()
os.system('rsgisexe -x ' + outXMLName)
os.remove(outXMLName)


